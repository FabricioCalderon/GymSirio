{% include 'admin_nav.html' %}
{% include 'base.html' %}
{% block content %}
{% load static %}


<!DOCTYPE html>
<header>
    {% block css %}
    <link rel="stylesheet" href="{% static '/estilos.css' %}">
    {% endblock %}
</header>


<div class="container mt-3">
    <form method="GET" action="{% url 'ListarSociosIngresados' %}">
    </form>
</div>


<head>
    <link rel="stylesheet" href="{% static '/estilos.css' %}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

</head>


<body>
    <style> 
         body {
            min-height: 100vh;
            background: linear-gradient(135deg, rgba(45, 0, 60, 0.95), rgba(15, 5, 100, 0.85));
            display: flex;
            flex-direction: column;
            font-family: 'Segoe UI', Roboto, sans-serif;
            color: #ffffff;
            margin: 0;
        }
        tr.table-danger {
            background-color: #f8d7da !important; /* Forzamos el color */
        }
        tr[data-vencido="true"] {
            background-color: #f8d7da !important;
        }

        .bg-activo {
         background-color: #7deb97; /* Verde clarito */
        }

        .bg-vencido {
            background-color: #f5b7bc; /* Rojo clarito */
        }
    </style>


<div class="container">
    <h1>Registro de Asistencia </h1>
    <div class="table-responsive">
        <div class="row g-2 align-items-center">
            <div class="col-md-3">
                <input type="date" class="form-control" id="fecha" name="fecha" value="{{ hoy }}">
            </div>


            <!-- Botón de búsqueda -->
            <div class="col-auto">
                <button class="btn btn-primary" type="submit" id="buscar">
                    <i class="fas fa-search"></i> Buscar
                </button>
            </div>
        </div>


        <table class="table table-striped table-hover rounded mt-3">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Fecha</th>
                    <th>Hora de Ingreso</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody id="tablaSocios">
                {% for asistencia in page_obj %}
                    {% with subscripcion=asistencia.subscripcion %}
                        {% if subscripcion.dias <= 0 or subscripcion.fecha_fin < today %}
                            <tr>
                        {% else %}
                            <tr>
                        {% endif %}
                            <td>{{ subscripcion.socio.Nombre }}</td>
                            <td>{{ asistencia.fecha_asistencia|date:"d/m/Y" }}</td>
                            <td>{{ asistencia.fecha_asistencia|time:"H:i:s" }}</td>
                            <td>
                                {% if subscripcion.dias <= 0 or subscripcion.fecha_fin < today %}
                                    <span class="text-danger">
                                        <i class="fas fa-times-circle"></i> <!-- Icono de cruz (denegado) -->
                                        Vencido
                                    </span>
                                {% else %}
                                    <span class="text-success">
                                        <i class="fas fa-check-circle"></i> <!-- Icono de tilde (aceptado) -->
                                        Activo
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endwith %}
                {% empty %}
                    <tr>
                        <td colspan="3" class="text-center">No hay registros.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>


<!-- Contenedor para la paginación -->
<div id="paginacion" class="pagination justify-content-center mt-3">
    {% if page_obj.has_previous %}
        <a class="btn btn-sm btn-outline-light text-dark rounded-pill me-2" href="?page={{ page_obj.previous_page_number }}" aria-label="Página anterior">
            &laquo; Anterior
        </a>
    {% endif %}


    <span class="btn btn-sm btn-outline-light text-dark rounded-pill disabled">
        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
    </span>


    {% if page_obj.has_next %}
        <a class="btn btn-sm btn-outline-light text-dark rounded-pill ms-2" href="?page={{ page_obj.next_page_number }}" aria-label="Página siguiente">
            Siguiente &raquo;
        </a>
    {% endif %}
</div>


<!-- AJAX para Filtrar por Fecha y manejar la Paginación -->
<script>
    $(document).ready(function () {
        function cargarRegistros(fecha, pagina = 1) {
            $.ajax({
                type: "GET",
                url: "{% url 'ListarSociosIngresados' %}",
                data: { fecha: fecha, page: pagina },
                success: function (response) {
                    let tabla = $("#tablaSocios");
                    tabla.empty();  // Limpiar la tabla antes de agregar nuevos datos


                    if (response.status === "success" && response.registros.length > 0) {
                        response.registros.forEach(function (registro) {
                            let fila = $("<tr></tr>");


                            // Determinamos si la suscripción está vencida o activa, basándonos en el valor que llega del backend
                            let vencido = registro.suscripcion_vencida 
                            ? "<span class='text-danger'><i class='fas fa-times-circle'></i> Vencido</span>"
                            : "<span class='text-success'><i class='fas fa-check-circle'></i> Activo</span>";

                           // Asignamos el estilo en línea
                            let estadoClase = registro.suscripcion_vencida ? "bg-vencido" : "bg-activo";
                            let colorFondo = registro.suscripcion_vencida ? "#f5b7bc" : "#7deb97";  // Rojo claro o verde claro

                            fila.append(`<td style="background-color: ${colorFondo};">${registro.nombre}</td>`);
                            fila.append(`<td style="background-color: ${colorFondo};">${registro.fecha}</td>`);
                            fila.append(`<td style="background-color: ${colorFondo};">${registro.hora_ingreso}</td>`);
                            fila.append(`<td style="background-color: ${colorFondo};">${vencido}</td>`);


                            tabla.append(fila);
                        });
                    } else {
                        tabla.append('<tr><td colspan="4" class="text-center">No hay registros disponibles para esta fecha.</td></tr>');
                    }


                    // Actualizamos la paginación
                    $("#paginacion").html(response.paginacion);
                },
                error: function () {
                    alert("Hubo un error al obtener los registros.");
                }
            });
        }


        let fechaInicial = $("#fecha").val();
        cargarRegistros(fechaInicial);


        $("#buscar").click(function () {
            let fechaSeleccionada = $("#fecha").val();
            if (fechaSeleccionada) {
                cargarRegistros(fechaSeleccionada, 1);
            } else {
                alert("Por favor, selecciona una fecha.");
            }
        });


        $(document).on("click", ".pagination a", function (event) {
            event.preventDefault();
            let pagina = $(this).attr("href").split("page=")[1];
            let fechaSeleccionada = $("#fecha").val();
            cargarRegistros(fechaSeleccionada, pagina);
        });
    });
</script>




</html>
{% endblock %}
